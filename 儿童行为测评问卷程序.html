<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conners Child Behavior Questionnaire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="radio"]:focus-visible + label {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-900 mb-2">Conners儿童行为问卷</h1>
            <p class="text-center text-gray-500 mb-8">Conners Child Behavior Questionnaire</p>
            <p class="text-center text-sm text-gray-600 mb-8">指导语：请根据您孩子最近一月内的情况，对下列项目进行评定。每个项目按“无”、“稍有”、“相当多”、“很多”四个等级进行评分。</p>

            <!-- Demographics -->
            <div id="demographics-section" class="mb-8 p-4 bg-blue-50 rounded-lg">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">儿童信息 (Child's Information)</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="child-age" class="block text-sm font-medium text-gray-700">年龄 (Age)</label>
                        <input type="number" id="child-age" name="child-age" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="请输入3-16之间的整数">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">性别 (Gender)</label>
                        <div class="flex items-center gap-4 mt-2">
                           <div class="flex items-center">
                                <input type="radio" id="male" name="gender" value="male" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="male" class="ml-2 block text-sm font-medium text-gray-700">男性 (Male)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="female" name="gender" value="female" class="h-4 w-4 text-pink-600 border-gray-300 focus:ring-pink-500">
                                <label for="female" class="ml-2 block text-sm font-medium text-gray-700">女性 (Female)</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Excel Import -->
            <div id="excel-import-section" class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">从Excel导入答案 (Import Answers from Excel)</h2>
                <p class="text-sm text-gray-500 mb-4">请先填写儿童信息。文件格式：第一列题号，第二列答案 (0=无, 1=稍有, 2=相当多, 3=很多)。</p>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <input type="file" id="excel-file-input" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".xlsx, .xls">
                    <button id="import-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-300 w-full sm:w-auto flex-shrink-0">
                        导入并计算
                    </button>
                </div>
            </div>
            
            <!-- Questions Grid -->
            <div id="questions-container" class="space-y-4 mt-8 pt-6 border-t border-gray-200">
                 <h2 class="text-lg font-semibold mb-3 text-gray-700">在线完成问卷 (Complete Online)</h2>
            </div>

            <!-- Action Button -->
            <div class="mt-10 text-center">
                <button id="calculate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    计算分数 (Calculate Score)
                </button>
            </div>
        </div>

        <!-- Results Modal -->
        <div id="results-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden transition-opacity duration-300">
            <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-2xl w-full transform transition-all duration-300 scale-95 opacity-0 overflow-y-auto max-h-screen" id="results-content">
                <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">测评结果 (Results)</h2>
                <div id="results-table-container" class="overflow-x-auto">
                    <!-- Results table will be injected here -->
                </div>
                <div class="mt-8 text-center flex flex-col sm:flex-row justify-center gap-3">
                     <button id="export-excel-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition focus:outline-none focus:ring-4 focus:ring-blue-300">
                        导出Excel
                    </button>
                    <button id="export-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition focus:outline-none focus:ring-4 focus:ring-green-300">
                        导出PDF
                    </button>
                    <button id="close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition focus:outline-none focus:ring-4 focus:ring-gray-300">
                        关闭
                    </button>
                </div>
            </div>
        </div>
        
        <div id="error-box" class="fixed top-5 right-5 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md shadow-lg hidden transition-opacity duration-300" role="alert">
            <p class="font-bold">错误 (Error)</p>
            <p id="error-message">Please answer all questions.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            // DOM Elements
            const questionsContainer = document.getElementById('questions-container');
            const calculateBtn = document.getElementById('calculate-btn');
            const resultsModal = document.getElementById('results-modal');
            const resultsContent = document.getElementById('results-content');
            const resultsTableContainer = document.getElementById('results-table-container');
            const closeBtn = document.getElementById('close-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const importBtn = document.getElementById('import-btn');
            const fileInput = document.getElementById('excel-file-input');
            const ageInput = document.getElementById('child-age');
            const errorBox = document.getElementById('error-box');
            const errorMessageEl = document.getElementById('error-message');

            let currentResults = {};
            let currentUserAnswers = [];

            const questions = [
                "某种小动作（如咬指甲、吸手指、拉头发、拉衣服上的布毛）", "对大人粗鲁无礼", "在交朋友或保持友谊上存在问题", "易兴奋，易冲动", "爱指手划脚", "吸吮或咬嚼（拇指、衣服、毯子）", "容易或经常哭叫", "脾气很大", "白日梦", "学习困难", "扭动不安", "惧怕（新环境、陌生人、陌生地方、上学）", "坐立不定，经常“忙碌”", "破坏性", "撒谎或捏造情节", "怕羞", "造成的麻烦比同龄孩子多", "说话与同龄儿童不同（像婴儿说话、口吃、别人不易听懂）", "抵赖错误或归罪他人", "好争吵", "撅嘴和生气", "偷窃", "不服从或勉强服从", "忧虑比别人多（忧虑、孤独、疾病、死亡）", "做事有始无终", "感情易受损害", "欺凌别人", "不能停止重复性活动", "残忍", "稚气或不成熟（自己会的事要人帮忙，依缠别人，常需别人鼓励、支持）", "容易分心或注意力不集中成为一个问题", "头痛", "情绪变化迅速剧烈", "不喜欢或不遵从纪律或约束", "经常打架", "与兄弟姐妹不能很好相处", "在努力中容易泄气", "妨害其他儿童", "基本上是一个不愉快的小孩", "有饮食问题（食欲不佳、进食中常跑开）", "胃痛", "有睡眠问题（不能入睡、早醒、夜间起床）", "其他疼痛", "呕吐或恶心", "感到在家庭圈子中被欺骗", "自夸和吹牛", "让自己受别人欺侮", "有大便问题（腹泻、排便不规则、便秘）"
            ];
            const questions_en = [
                "Tics (e.g., nail biting, thumb sucking, pulling hair, pulling at clothes)", "Rude to adults", "Problems with making or keeping friends", "Excitable, impulsive", "Bossy", "Sucking or chewing (thumb, clothes, blankets)", "Cries easily or often", "Quick-tempered", "Daydreams", "Learning difficulties", "Restless or fidgety", "Fearful (of new situations, strangers, new places, school)", "Restless, always 'busy'", "Destructive", "Lies or makes up stories", "Shy", "More trouble than same-aged children", "Speech problems (like baby talk, stuttering, hard to understand)", "Denies mistakes or blames others", "Argumentative", "Pouts and sulks", "Steals", "Disobedient or reluctantly obedient", "Worries more than others (about being alone, illness, death)", "Fails to finish things", "Easily hurt emotionally", "Bullies others", "Cannot stop repetitive activities", "Cruel", "Immature (needs help for things he/she can do, clings, needs encouragement)", "Easily distracted or has poor attention span", "Headaches", "Rapid and drastic mood changes", "Dislikes or disobeys rules or restrictions", "Fights frequently", "Does not get along well with siblings", "Easily discouraged in efforts", "Disturbs other children", "Basically an unhappy child", "Eating problems (poor appetite, often runs off during meals)", "Stomachaches", "Sleep problems (can't fall asleep, wakes up early, gets up at night)", "Other pains", "Vomiting or nausea", "Feels cheated in family circle", "Boasts and brags", "Lets self be picked on by others", "Bowel problems (diarrhea, irregular movements, constipation)"
            ];

            const factors = {
                'I': { name: '品行问题', name_en: 'Conduct Problems', items: [2, 8, 14, 19, 20, 21, 22, 23, 27, 33, 34, 39] },
                'II': { name: '学习问题', name_en: 'Learning Problems', items: [10, 25, 31, 37] },
                'III': { name: '心身障碍', name_en: 'Psychosomatic Problems', items: [32, 41, 43, 44, 48] },
                'IV': { name: '冲动-多动', name_en: 'Impulsive-Hyperactive', items: [4, 5, 11, 13] },
                'V': { name: '焦虑', name_en: 'Anxiety', items: [12, 16, 24, 47] },
                'VI': { name: '多动指数', name_en: 'Hyperactivity Index', items: [4, 7, 11, 13, 14, 25, 31, 33, 37, 38] }
            };

            const norms = {
                '3-5': {
                    'male': { I: { X: 0.53, SD: 0.39 }, II: { X: 0.50, SD: 0.33 }, III: { X: 0.07, SD: 0.15 }, IV: { X: 1.01, SD: 0.65 }, V: { X: 0.60, SD: 0.61 }, VI: { X: 0.72, SD: 0.40 } },
                    'female': { I: { X: 0.49, SD: 0.35 }, II: { X: 0.62, SD: 0.57 }, III: { X: 0.10, SD: 0.17 }, IV: { X: 1.15, SD: 0.77 }, V: { X: 0.51, SD: 0.59 }, VI: { X: 0.78, SD: 0.56 } }
                },
                '6-8': {
                    'male': { I: { X: 0.50, SD: 0.40 }, II: { X: 0.64, SD: 0.45 }, III: { X: 0.13, SD: 0.23 }, IV: { X: 0.93, SD: 0.60 }, V: { X: 0.51, SD: 0.51 }, VI: { X: 0.69, SD: 0.46 } },
                    'female': { I: { X: 0.41, SD: 0.28 }, II: { X: 0.45, SD: 0.38 }, III: { X: 0.19, SD: 0.27 }, IV: { X: 0.95, SD: 0.59 }, V: { X: 0.57, SD: 0.66 }, VI: { X: 0.59, SD: 0.35 } }
                },
                '9-11': {
                    'male': { I: { X: 0.53, SD: 0.38 }, II: { X: 0.54, SD: 0.52 }, III: { X: 0.18, SD: 0.26 }, IV: { X: 0.92, SD: 0.60 }, V: { X: 0.42, SD: 0.47 }, VI: { X: 0.66, SD: 0.44 } },
                    'female': { I: { X: 0.40, SD: 0.36 }, II: { X: 0.43, SD: 0.38 }, III: { X: 0.17, SD: 0.28 }, IV: { X: 0.80, SD: 0.59 }, V: { X: 0.49, SD: 0.57 }, VI: { X: 0.52, SD: 0.34 } }
                },
                '12-14': {
                    'male': { I: { X: 0.49, SD: 0.41 }, II: { X: 0.66, SD: 0.57 }, III: { X: 0.22, SD: 0.44 }, IV: { X: 0.82, SD: 0.54 }, V: { X: 0.58, SD: 0.59 }, VI: { X: 0.62, SD: 0.45 } },
                    'female': { I: { X: 0.39, SD: 0.40 }, II: { X: 0.44, SD: 0.45 }, III: { X: 0.23, SD: 0.28 }, IV: { X: 0.72, SD: 0.55 }, V: { X: 0.54, SD: 0.53 }, VI: { X: 0.49, SD: 0.34 } }
                },
                '15-17': {
                    'male': { I: { X: 0.47, SD: 0.44 }, II: { X: 0.62, SD: 0.55 }, III: { X: 0.13, SD: 0.26 }, IV: { X: 0.70, SD: 0.51 }, V: { X: 0.59, SD: 0.58 }, VI: { X: 0.51, SD: 0.41 } },
                    'female': { I: { X: 0.37, SD: 0.33 }, II: { X: 0.35, SD: 0.38 }, III: { X: 0.19, SD: 0.25 }, IV: { X: 0.60, SD: 0.55 }, V: { X: 0.51, SD: 0.53 }, VI: { X: 0.42, SD: 0.34 } }
                }
            };

            function getAgeGroup(age) {
                if (age >= 3 && age <= 5) return '3-5';
                if (age >= 6 && age <= 8) return '6-8';
                if (age >= 9 && age <= 11) return '9-11';
                if (age >= 12 && age <= 14) return '12-14';
                if (age >= 15 && age <= 16) return '15-17';
                return null;
            }

            function generateQuestions() {
                let questionsHTML = '';
                const options = ['无', '稍有', '相当多', '很多'];
                questions.forEach((text, index) => {
                    const i = index + 1;
                    let optionsHTML = '';
                    options.forEach((opt, val) => {
                        optionsHTML += `
                            <div class="flex items-center">
                                <input type="radio" id="q${i}-${val}" name="q${i}" value="${val}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <label for="q${i}-${val}" class="ml-2 text-sm text-gray-600">${opt}</label>
                            </div>`;
                    });
                    questionsHTML += `
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <span class="font-medium text-gray-700 mb-2 sm:mb-0">${i}. ${text}</span>
                            <div class="flex items-center space-x-4 flex-shrink-0">${optionsHTML}</div>
                        </div>`;
                });
                questionsContainer.innerHTML += questionsHTML;
            }

            function showError(message) {
                errorMessageEl.textContent = message;
                errorBox.classList.remove('hidden');
                setTimeout(() => { errorBox.classList.add('hidden'); }, 3000);
            }

            function validateInputs() {
                const age = parseInt(ageInput.value, 10);
                const gender = document.querySelector('input[name="gender"]:checked');
                if (isNaN(age) || age < 3 || age > 16) {
                    showError('请输入有效的年龄 (3-16岁)。');
                    return null;
                }
                if (!gender) {
                    showError('请选择性别。');
                    return null;
                }
                return { age, gender: gender.value };
            }

            function performCalculation(answers, age, gender) {
                if (answers.some(a => a === null)) {
                    showError(`请回答所有 ${questions.length} 个问题。`);
                    return;
                }
                
                currentUserAnswers = answers;
                const ageGroup = getAgeGroup(age);
                if (!ageGroup) {
                    showError('年龄超出常模范围 (3-16岁)。');
                    return;
                }
                const normData = norms[ageGroup][gender];
                const options = ['无', '稍有', '相当多', '很多'];
                const options_en = ['None', 'A little', 'Quite a bit', 'Very much'];
                
                let results = {};
                for (const factorId in factors) {
                    const factor = factors[factorId];
                    let rawScore = 0;
                    let contributingItems = [];

                    factor.items.forEach(itemIndex => {
                        const answerValue = answers[itemIndex - 1];
                        rawScore += answerValue;
                        if (answerValue >= 2) { // "相当多" or "很多"
                            contributingItems.push({
                                id: itemIndex,
                                text: questions[itemIndex - 1],
                                text_en: questions_en[itemIndex - 1],
                                answer: options[answerValue],
                                answer_en: options_en[answerValue]
                            });
                        }
                    });

                    const factorScore = rawScore / factor.items.length;
                    const norm = normData[factorId];
                    const upperLimit = norm.X + 2 * norm.SD;
                    const isAbnormal = factorScore > upperLimit;
                    
                    results[factorId] = {
                        name: factor.name,
                        name_en: factor.name_en,
                        rawScore: rawScore,
                        factorScore: factorScore.toFixed(2),
                        norm: `X=${norm.X}, SD=${norm.SD}`,
                        interpretation: isAbnormal ? '异常' : '正常',
                        interpretation_en: isAbnormal ? 'Abnormal' : 'Normal',
                        contributingItems: isAbnormal ? contributingItems : []
                    };
                }
                displayResults(results);
            }

            function calculateScoreFromForm() {
                const inputs = validateInputs();
                if (!inputs) return;
                
                const answers = [];
                let allAnswered = true;
                for (let i = 1; i <= questions.length; i++) {
                    const answerEl = document.querySelector(`input[name="q${i}"]:checked`);
                    if (answerEl) {
                        answers.push(parseInt(answerEl.value, 10));
                    } else {
                        allAnswered = false;
                        break;
                    }
                }

                if (!allAnswered) {
                    showError(`请回答所有 ${questions.length} 个问题。`);
                    return;
                }
                performCalculation(answers, inputs.age, inputs.gender);
            }
            
            function displayResults(results) {
                currentResults = results;
                let tableHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">因子</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原始分</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">因子分</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">结果</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;

                for (const factorId in results) {
                    const res = results[factorId];
                    const interpretationClass = res.interpretation === '异常' ? 'text-red-600 font-bold' : 'text-green-600';
                    tableHTML += `
                        <tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${res.name}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${res.rawScore}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${res.factorScore}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm ${interpretationClass}">${res.interpretation}</td>
                        </tr>`;
                    if (res.contributingItems.length > 0) {
                        tableHTML += `<tr class="bg-gray-50"><td colspan="4" class="px-4 py-2 text-xs text-gray-700">
                            <details><summary class="cursor-pointer font-semibold">关键题目分析</summary>
                            <div class="pt-2 pl-4">
                                <p class="text-xs text-gray-500 mb-1">以下“相当多”或“很多”的回答主要导致了此项分数的异常：</p>
                                <ul class="list-disc list-inside">`;
                        res.contributingItems.forEach(item => {
                            tableHTML += `<li class="text-xs">${item.id}. ${item.text} (您的回答: <strong>${item.answer}</strong>)</li>`;
                        });
                        tableHTML += `</ul></div></details></td></tr>`;
                    }
                }
                tableHTML += `</tbody></table>`;
                resultsTableContainer.innerHTML = tableHTML;
                
                resultsModal.classList.remove('hidden');
                setTimeout(() => {
                    resultsModal.classList.add('opacity-100');
                    resultsContent.classList.remove('scale-95', 'opacity-0');
                    resultsContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            function closeModal() {
                resultsModal.classList.remove('opacity-100');
                resultsContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { resultsModal.classList.add('hidden'); }, 300);
            }

            function exportToPDF() {
                try {
                    const doc = new jsPDF();
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(18);
                    doc.text("Conners Child Behavior Questionnaire Results", 105, 15, { align: 'center' });

                    let finalY = 25;
                    
                    doc.autoTable({
                        head: [['Factor', 'Raw Score', 'Factor Score', 'Result']],
                        body: Object.values(currentResults).map(res => [res.name_en, res.rawScore, res.factorScore, res.interpretation_en]),
                        startY: finalY,
                        headStyles: { fillColor: [22, 160, 133] },
                        styles: { font: 'helvetica', fontSize: 10 },
                    });
                    finalY = doc.lastAutoTable.finalY + 10;

                    for (const factorId in currentResults) {
                        const res = currentResults[factorId];
                        if (res.contributingItems.length > 0) {
                            if (finalY > 260) { doc.addPage(); finalY = 20; }
                            doc.setFont("helvetica", "bold");
                            doc.setFontSize(10);
                            doc.text(`Key Item Analysis for: ${res.name_en}`, 14, finalY);
                            finalY += 5;
                            doc.setFont("helvetica", "normal");
                            doc.setFontSize(8);
                            const itemsText = res.contributingItems.map(item => `Q${item.id}: ${item.text_en} (Answer: "${item.answer_en}")`).join('\n');
                            const splitText = doc.splitTextToSize(itemsText, 180);
                            doc.text(splitText, 16, finalY);
                            finalY += (splitText.length * 3.5) + 5;
                        }
                    }

                    doc.save("Conners-Results.pdf");
                } catch (err) {
                    console.error("PDF Export Error:", err);
                    showError("导出PDF失败 (Failed to export PDF.)");
                }
            }

            function exportToExcel() {
                const data = [["Question No.", "Question (Chinese)", "Question (English)", "Answer (0-3)"]];
                const answerLabels = ['无', '稍有', '相当多', '很多'];
                for(let i = 0; i < questions.length; i++) {
                    const answerValue = currentUserAnswers[i];
                    data.push([i + 1, questions[i], questions_en[i], `${answerValue} (${answerLabels[answerValue]})`]);
                }
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Answers");
                XLSX.writeFile(wb, "Conners-Answers.xlsx");
            }

            function handleFileUpload(event) {
                const inputs = validateInputs();
                if (!inputs) {
                    fileInput.value = '';
                    return;
                }

                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        if (json.length < questions.length) { 
                            throw new Error(`Excel文件内容不完整，应包含 ${questions.length} 行答案。`);
                        }

                        const answers = [];
                        for (let i = 0; i < questions.length; i++) {
                            const row = json[i];
                            const questionNumber = i + 1;
                            if (!row || row[1] === undefined || row[1] === null) throw new Error(`第 ${questionNumber} 行答案缺失。`);
                            const answer = parseInt(row[1], 10);
                            if (isNaN(answer) || answer < 0 || answer > 3) throw new Error(`第 ${questionNumber} 行的答案 "${row[1]}" 无效，请输入 0-3。`);
                            answers.push(answer);
                        }
                        performCalculation(answers, inputs.age, inputs.gender);
                    } catch (err) {
                        showError(`文件处理失败: ${err.message}`);
                    } finally {
                        fileInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            // Event Listeners
            calculateBtn.addEventListener('click', calculateScoreFromForm);
            closeBtn.addEventListener('click', closeModal);
            exportPdfBtn.addEventListener('click', exportToPDF);
            exportExcelBtn.addEventListener('click', exportToExcel);
            importBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            resultsModal.addEventListener('click', (e) => {
                if (e.target === resultsModal) closeModal();
            });

            generateQuestions();
        });
    </script>
</body>
</html>
