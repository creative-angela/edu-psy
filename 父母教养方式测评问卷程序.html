<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parental Rearing Style Questionnaire (EMBU)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="radio"]:focus-visible + label {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
            border-radius: 0.25rem;
        }
        .details-content {
            display: none;
            padding-left: 1rem;
            padding-top: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-900 mb-2">父母教养方式问卷 (EMBU)</h1>
            <p class="text-center text-gray-500 mb-8">Egna Minnen Beträffande Uppfostran</p>
            <p class="text-center text-sm text-gray-600 mb-8">指导语：问卷旨在了解您在16岁以前，父母对您的教养方式。请您仔细阅读每个问题，并根据您的实际情况，对父亲和母亲的情况分别进行评分。</p>

            <!-- Excel Import -->
            <div id="excel-import-section" class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">从Excel导入答案 (Import Answers from Excel)</h2>
                <p class="text-sm text-gray-500 mb-4">文件格式：共三列。第一列题号，第二列父亲的答案(1-4)，第三列母亲的答案(1-4)。</p>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <input type="file" id="excel-file-input" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".xlsx, .xls">
                    <button id="import-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-300 w-full sm:w-auto flex-shrink-0">
                        导入并计算
                    </button>
                </div>
            </div>
            
            <!-- Questions Grid -->
            <div id="questions-container" class="space-y-4 mt-8 pt-6 border-t border-gray-200">
                 <h2 class="text-lg font-semibold mb-3 text-gray-700">在线完成问卷 (Complete Online)</h2>
                 <div class="grid grid-cols-1 md:grid-cols-3 items-center bg-gray-100 p-2 rounded-md mb-4">
                    <div class="font-bold text-gray-700 col-span-1">题目</div>
                    <div class="font-bold text-gray-700 text-center">父亲 (Father)</div>
                    <div class="font-bold text-gray-700 text-center">母亲 (Mother)</div>
                 </div>
            </div>

            <!-- Action Button -->
            <div class="mt-10 text-center">
                <button id="calculate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    计算分数 (Calculate Score)
                </button>
            </div>
        </div>

        <!-- Results Modal -->
        <div id="results-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden transition-opacity duration-300">
            <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-4xl w-full transform transition-all duration-300 scale-95 opacity-0 overflow-y-auto max-h-screen" id="results-content">
                <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">测评结果 (Results)</h2>
                <div id="results-table-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Results tables will be injected here -->
                </div>
                <div class="mt-4 p-4 bg-gray-50 rounded-lg text-sm text-gray-600">
                    <p><span class="font-bold">结果说明：</span>Z分数表示您的得分与同龄人平均水平的差距，单位为标准差。Z分数的绝对值越大，表示偏离平均水平越远。“显著高/低”表示您的得分显著偏离平均水平，可能对您的成长有更突出的影响。</p>
                </div>
                <div class="mt-8 text-center flex flex-col sm:flex-row justify-center gap-3">
                     <button id="export-excel-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition focus:outline-none focus:ring-4 focus:ring-blue-300">
                        导出Excel
                    </button>
                    <button id="export-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition focus:outline-none focus:ring-4 focus:ring-green-300">
                        导出PDF
                    </button>
                    <button id="close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition focus:outline-none focus:ring-4 focus:ring-gray-300">
                        关闭
                    </button>
                </div>
            </div>
        </div>
        
        <div id="error-box" class="fixed top-5 right-5 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md shadow-lg hidden transition-opacity duration-300" role="alert">
            <p class="font-bold">错误 (Error)</p>
            <p id="error-message">Please answer all questions.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            const questionsContainer = document.getElementById('questions-container');
            const calculateBtn = document.getElementById('calculate-btn');
            const resultsModal = document.getElementById('results-modal');
            const resultsContent = document.getElementById('results-content');
            const resultsTableContainer = document.getElementById('results-table-container');
            const closeBtn = document.getElementById('close-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const importBtn = document.getElementById('import-btn');
            const fileInput = document.getElementById('excel-file-input');
            const errorBox = document.getElementById('error-box');
            const errorMessageEl = document.getElementById('error-message');

            let currentResults = {};
            let currentUserAnswers = { father: [], mother: [] };

            const questions = [
                "我觉得父母干涉我所做的每一件事", "我能通过父母的言语表情感受他（她）很喜欢我", "与我的兄弟姐妹相比父母更宠爱我", "我能感到父母对我的喜爱", "即使是很小的过失,父母也惩罚我", "父母总试图潜移默化地影响，使我成为出类拔萃的人", "我觉得父母允许我在某些方面有独到之处", "父母能让我得到其他兄弟姐妹得不到的东西", "父母对我的惩罚是公平且恰当的", "我觉得父母对我很严厉", "父母总是左右我该穿什么衣服或该打扮成什么样子", "父母不允许我做一些其他孩子可以做的事，因为他们害怕我会出事", "在我小时候父母曾当着别人的面打我或训斥我", "父母总是很关注我晚上干什么", "当我遇到不顺心的事时，我能感到父母在尽量鼓励我，使我得到一些安慰", "父母总是过分担心我的健康", "父母对我的惩罚往往超过我应受的程度", "如果我在家里不听吩咐，父母就会恼怒", "如果我做错了什么事，父母总是以一种伤心样子使我有一种犯罪感或负疚感", "我觉得父母难以接近", "父母曾在别人面前唠叨一些我说过的话或做过的事，这使我感到难过", "我觉得父母更喜欢我，而不是我的兄弟姐妹", "在满足我需要的东西，父母是很小气的", "父母常常很在乎我取得分数", "如果面临一项困难的任务，我能感到来自父母的支持", "我在家里往往被当作“替罪羊”或“害群之马”", "父母总是挑剔我所喜欢的朋友", "父母总以为他们的不快是由我引起的", "父母总试图鼓励我，使我成为佼佼者", "父母总向我表示他们是爱我的", "父母对我很信任且允许我独自完成某些事情", "我觉得父母很尊重我的观点", "我觉得父母很愿意跟我在一起", "我觉得父母对我很小气、很吝啬", "父母总是向我说类似这样的话“如果你这样做我会很伤心”", "父母要求我回到家里必须得向他们说明我在做的事情", "我觉得父母在尽量使我的青春更有意义和丰富多彩（如给我买很多书，安排我去夏令营或参加俱乐部）", "父母经常向我表示类似这样的话“这就是我们为你整日操劳而得到的报答吗？”", "父母常以不能娇惯我为借口不满足我的要求", "如果不按父母所期望的去做，就会使我的良心上感到不安", "我觉得父母对我的学习成绩，体育活动或类似的事情有较高的要求", "当我感到伤心的时候可以从父母那儿得到安慰", "父母曾无缘无故地惩罚我", "父母允许我做一些我的朋友们做的事情", "父母经常对我说他们不喜欢我在家的表现", "每当我吃饭时，父母就劝我或强迫我再多吃一点", "父母经常当着别人的面批评我既慵惰，又无用", "父母常常关注我交往什么样的朋友", "如果发生什么事情，我常常是兄弟姐妹中唯一受责备的人", "父母能让我顺其自然地发展", "父母经常对我粗俗无礼", "有时甚至为一点儿鸡毛蒜皮的小事，父母也会严厉的惩罚我", "父母甚至无缘无故地打过我", "父母通常会参与我的业余爱好活动", "我经常挨父母的打", "父母常常允许我到我喜欢去的地方，而他们又不会过分担心", "父母对我该做什么，不该做什么都有严格的限制而且绝不让步", "父母常以一种使我很难堪的方式对待我", "我觉得父母对我可能出事的担心是夸大的、过分的", "我觉得与父母之间存在一种温暖、体贴和亲热感觉", "父母能容忍我与他们有不同的见解", "父母常常在我不知道原因的情况下对我大发脾气", "当我所做的事情取得成功时，我觉得父母很为我自豪", "与我的兄弟姐妹相比，父母常常偏爱我", "有时即使错误在我，父母也会把责任归咎于兄弟姐妹", "父母经常抱我"
            ];
            const questions_en = [
                "I feel that my parents interfere with everything I do", "I can feel that he/she likes me through my parents' words and expressions", "My parents spoil me more than my siblings", "I can feel my parents' love for me", "Even for small mistakes, my parents punish me", "My parents always try to influence me subtly to become outstanding", "I feel that my parents allow me to have unique strengths in some areas", "My parents can give me things that other siblings can't get", "My parents' punishment is fair and appropriate", "I feel that my parents are very strict with me", "My parents always control what clothes I should wear or how I should dress", "My parents don't allow me to do things that other children can do because they are afraid I will get into trouble", "My parents have hit or scolded me in front of others when I was a child", "My parents are always very concerned about what I do at night", "When I encounter something unpleasant, I can feel my parents trying their best to encourage me and give me some comfort", "My parents are always overly worried about my health", "My parents' punishment often exceeds what I deserve", "If I don't listen to instructions at home, my parents will get angry", "If I do something wrong, my parents always look sad to make me feel guilty", "I find it difficult to get close to my parents", "My parents have gossiped in front of others about things I have said or done, which makes me sad", "I feel that my parents like me more than my siblings", "My parents are very stingy in satisfying my needs", "My parents often care a lot about my grades", "If I face a difficult task, I can feel support from my parents", "I am often treated as a 'scapegoat' or 'black sheep' at home", "My parents are always critical of the friends I like", "My parents always think that their unhappiness is caused by me", "My parents always try to encourage me to be the best", "My parents always show me that they love me", "My parents trust me very much and allow me to accomplish certain things on my own", "I feel that my parents respect my opinions very much", "I feel that my parents are very willing to be with me", "I feel that my parents are very stingy and mean to me", "My parents always say things to me like 'I will be very sad if you do this'", "My parents require me to explain what I was doing when I get home", "I feel that my parents try their best to make my youth more meaningful and colorful (such as buying me many books, arranging for me to go to summer camp or join a club)", "My parents often say things to me like 'Is this what we get for working hard for you all day?'", "My parents often refuse to meet my demands on the grounds that I cannot be spoiled", "If I don't do what my parents expect, I will feel uneasy in my conscience", "I feel that my parents have high expectations for my academic performance, sports activities, or similar things", "When I feel sad, I can get comfort from my parents", "My parents have punished me for no reason", "My parents allow me to do some of the things my friends do", "My parents often tell me that they don't like my behavior at home", "Whenever I eat, my parents persuade or force me to eat more", "My parents often criticize me in front of others for being lazy and useless", "My parents often pay attention to the kind of friends I associate with", "If something happens, I am often the only one among my siblings to be blamed", "My parents can let me develop naturally", "My parents are often rude to me", "Sometimes even for trivial matters, my parents will punish me severely", "My parents have even hit me for no reason", "My parents usually participate in my hobbies", "I am often beaten by my parents", "My parents often allow me to go where I like without worrying too much", "My parents have strict restrictions on what I should and should not do and never give in", "My parents often treat me in a way that makes me very embarrassed", "I feel that my parents' worries about me getting into trouble are exaggerated and excessive", "I feel a sense of warmth, consideration, and affection between me and my parents", "My parents can tolerate me having different opinions from them", "My parents often lose their temper with me for no reason", "When I succeed in what I do, I feel that my parents are very proud of me", "Compared to my siblings, my parents often favor me", "Sometimes even when the fault is mine, my parents will blame my siblings", "My parents often hug me"
            ];
            
            const factors = {
                father: {
                    'F1': { name: '情感温暖与理解', name_en: 'Emotional Warmth & Understanding', items: [2, 4, 6, 7, 9, 15, 20, 25, 29, 30, 31, 32, 33, 37, 42, 44, 60, 61, 66], reverse: [20] },
                    'F2': { name: '惩罚严厉', name_en: 'Punishment & Severity', items: [5, 13, 17, 18, 43, 49, 51, 52, 53, 55, 58, 62], reverse: [] },
                    'F3': { name: '过分干涉', name_en: 'Over-interference', items: [1, 10, 11, 14, 27, 36, 48, 50, 56, 57], reverse: [50, 56] },
                    'F4': { name: '偏爱被试', name_en: 'Favoritism', items: [3, 8, 22, 64, 65], reverse: [] },
                    'F5': { name: '拒绝与否认', name_en: 'Rejection & Denial', items: [21, 23, 28, 34, 35, 45], reverse: [] },
                    'F6': { name: '过度保护', name_en: 'Overprotection', items: [12, 16, 39, 40, 46, 59], reverse: [] }
                },
                mother: {
                    'M1': { name: '情感温暖与理解', name_en: 'Emotional Warmth & Understanding', items: [2, 4, 6, 7, 9, 15, 25, 29, 30, 31, 32, 33, 37, 42, 44, 54, 60, 61, 63], reverse: [] },
                    'M2': { name: '过度干涉', name_en: 'Over-interference', items: [1, 11, 12, 14, 16, 19, 24, 27, 35, 36, 41, 48, 50, 56, 57, 59], reverse: [50, 56] },
                    'M3': { name: '拒绝否认', name_en: 'Rejection & Denial', items: [23, 26, 28, 34, 38, 39, 45, 47], reverse: [] },
                    'M4': { name: '惩罚严厉', name_en: 'Punishment & Severity', items: [13, 17, 43, 51, 52, 53, 55, 58, 62], reverse: [] },
                    'M5': { name: '偏爱被试', name_en: 'Favoritism', items: [3, 8, 22, 64, 65], reverse: [] }
                }
            };

            const norms = {
                father: { F1: { X: 51.54, SD: 8.89 }, F2: { X: 15.84, SD: 3.98 }, F3: { X: 20.92, SD: 3.66 }, F4: { X: 9.82, SD: 3.83 }, F5: { X: 8.27, SD: 2.40 }, F6: { X: 12.43, SD: 3.12 } },
                mother: { M1: { X: 55.71, SD: 9.31 }, M2: { X: 36.42, SD: 6.02 }, M3: { X: 11.47, SD: 3.26 }, M4: { X: 11.13, SD: 2.84 }, M5: { X: 9.99, SD: 3.81 } }
            };

            function generateQuestions() {
                let questionsHTML = '';
                const options = ['从不', '偶尔', '经常', '总是'];
                questions.forEach((text, index) => {
                    const i = index + 1;
                    let fatherOptionsHTML = '', motherOptionsHTML = '';
                    options.forEach((opt, val) => {
                        const score = val + 1;
                        fatherOptionsHTML += `<div class="flex items-center"><input type="radio" id="q${i}-father-${score}" name="q${i}-father" value="${score}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><label for="q${i}-father-${score}" class="ml-2 text-sm text-gray-600">${opt}</label></div>`;
                        motherOptionsHTML += `<div class="flex items-center"><input type="radio" id="q${i}-mother-${score}" name="q${i}-mother" value="${score}" class="h-4 w-4 text-pink-600 border-gray-300 focus:ring-pink-500"><label for="q${i}-mother-${score}" class="ml-2 text-sm text-gray-600">${opt}</label></div>`;
                    });

                    questionsHTML += `
                        <div class="grid grid-cols-1 md:grid-cols-3 items-center bg-gray-50 p-3 rounded-lg border border-gray-200 gap-4">
                            <span class="font-medium text-gray-700 col-span-1">${i}. ${text}</span>
                            <div class="flex items-center justify-around space-x-2 flex-wrap">${fatherOptionsHTML}</div>
                            <div class="flex items-center justify-around space-x-2 flex-wrap">${motherOptionsHTML}</div>
                        </div>`;
                });
                questionsContainer.innerHTML += questionsHTML;
            }

            function showError(message) {
                errorMessageEl.textContent = message;
                errorBox.classList.remove('hidden');
                setTimeout(() => { errorBox.classList.add('hidden'); }, 3000);
            }

            function getAnswersFromForm() {
                const answers = { father: [], mother: [] };
                let allAnswered = true;
                for (let i = 1; i <= questions.length; i++) {
                    const fatherAnswerEl = document.querySelector(`input[name="q${i}-father"]:checked`);
                    const motherAnswerEl = document.querySelector(`input[name="q${i}-mother"]:checked`);
                    if (fatherAnswerEl && motherAnswerEl) {
                        answers.father.push(parseInt(fatherAnswerEl.value, 10));
                        answers.mother.push(parseInt(motherAnswerEl.value, 10));
                    } else {
                        allAnswered = false;
                        break;
                    }
                }
                return allAnswered ? answers : null;
            }
            
            function getInterpretation(zScore) {
                if (zScore > 2) return { text: '显著高', text_en: 'Significantly High', class: 'text-red-600 font-bold' };
                if (zScore > 1) return { text: '偏高', text_en: 'High', class: 'text-orange-500' };
                if (zScore < -2) return { text: '显著低', text_en: 'Significantly Low', class: 'text-blue-600 font-bold' };
                if (zScore < -1) return { text: '偏低', text_en: 'Low', class: 'text-blue-400' };
                return { text: '平均范围', text_en: 'Average', class: 'text-green-600' };
            }

            function performCalculation(answers) {
                currentUserAnswers = answers;
                let results = { father: {}, mother: {} };
                const options = ['从不', '偶尔', '经常', '总是'];
                const options_en = ['Never', 'Occasionally', 'Often', 'Always'];

                ['father', 'mother'].forEach(parent => {
                    for (const factorId in factors[parent]) {
                        const factor = factors[parent][factorId];
                        let rawScore = 0;
                        let contributingItems = [];

                        factor.items.forEach(itemIndex => {
                            let userScore = answers[parent][itemIndex - 1];
                            let effectiveScore = userScore;
                            let isReversed = factor.reverse.includes(itemIndex);
                            if (isReversed) {
                                effectiveScore = 5 - userScore;
                            }
                            rawScore += effectiveScore;
                            
                            if ((!isReversed && userScore >= 3) || (isReversed && userScore <= 2)) {
                                contributingItems.push({ id: itemIndex, text: questions_en[itemIndex - 1], answer: options[userScore - 1], answer_en: options_en[userScore - 1], direction: 'high' });
                            } else if ((!isReversed && userScore <= 2) || (isReversed && userScore >= 3)) {
                                contributingItems.push({ id: itemIndex, text: questions_en[itemIndex - 1], answer: options[userScore - 1], answer_en: options_en[userScore - 1], direction: 'low' });
                            }
                        });
                        
                        const norm = norms[parent][factorId];
                        const zScore = (rawScore - norm.X) / norm.SD;
                        const interpretation = getInterpretation(zScore);
                        
                        let finalContributingItems = [];
                        if (zScore > 1) {
                            finalContributingItems = contributingItems.filter(item => item.direction === 'high');
                        } else if (zScore < -1) {
                            finalContributingItems = contributingItems.filter(item => item.direction === 'low');
                        }

                        results[parent][factorId] = {
                            name: factor.name,
                            name_en: factor.name_en,
                            zScore: zScore.toFixed(2),
                            interpretation: interpretation.text,
                            interpretation_en: interpretation.text_en,
                            interpretationClass: interpretation.class,
                            contributingItems: finalContributingItems
                        };
                    }
                });
                displayResults(results);
            }

            function calculateScoreFromForm() {
                const answers = getAnswersFromForm();
                if (!answers) {
                    showError(`请回答所有 ${questions.length} 个问题 (包括父亲和母亲)。`);
                    return;
                }
                performCalculation(answers);
            }
            
            function displayResults(results) {
                currentResults = results;
                let fatherTable = `<div><h3 class="text-xl font-semibold text-center mb-4 text-blue-700">父亲教养方式</h3><table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">维度</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Z分数</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">结果</th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
                for (const factorId in results.father) {
                    const res = results.father[factorId];
                    fatherTable += `<tr><td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${res.name}</td><td class="px-4 py-4 text-sm text-gray-500">${res.zScore}</td><td class="px-4 py-4 text-sm ${res.interpretationClass}">${res.interpretation}</td></tr>`;
                    if (res.contributingItems.length > 0) {
                        fatherTable += `<tr class="bg-gray-50"><td colspan="3" class="px-4 py-2 text-xs text-gray-700">
                            <details><summary class="cursor-pointer font-semibold">关键题目分析</summary>
                            <div class="pt-2 pl-4">
                                <p class="text-xs text-gray-500 mb-1">以下题目的回答主要导致了此项分数的偏离：</p>
                                <ul class="list-disc list-inside">`;
                        res.contributingItems.forEach(item => {
                            fatherTable += `<li class="text-xs">${item.id}. ${questions[item.id - 1]} (您的回答: <strong>${item.answer}</strong>)</li>`;
                        });
                        fatherTable += `</ul></div></details></td></tr>`;
                    }
                }
                fatherTable += `</tbody></table></div>`;

                let motherTable = `<div><h3 class="text-xl font-semibold text-center mb-4 text-pink-700">母亲教养方式</h3><table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">维度</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Z分数</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">结果</th></tr></thead>
                    <tbody class="bg-white divide-y divide-gray-200">`;
                for (const factorId in results.mother) {
                    const res = results.mother[factorId];
                    motherTable += `<tr><td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${res.name}</td><td class="px-4 py-4 text-sm text-gray-500">${res.zScore}</td><td class="px-4 py-4 text-sm ${res.interpretationClass}">${res.interpretation}</td></tr>`;
                     if (res.contributingItems.length > 0) {
                        motherTable += `<tr class="bg-gray-50"><td colspan="3" class="px-4 py-2 text-xs text-gray-700">
                            <details><summary class="cursor-pointer font-semibold">关键题目分析</summary>
                            <div class="pt-2 pl-4">
                                <p class="text-xs text-gray-500 mb-1">以下题目的回答主要导致了此项分数的偏离：</p>
                                <ul class="list-disc list-inside">`;
                        res.contributingItems.forEach(item => {
                            motherTable += `<li class="text-xs">${item.id}. ${questions[item.id - 1]} (您的回答: <strong>${item.answer}</strong>)</li>`;
                        });
                        motherTable += `</ul></div></details></td></tr>`;
                    }
                }
                motherTable += `</tbody></table></div>`;

                resultsTableContainer.innerHTML = fatherTable + motherTable;
                
                resultsModal.classList.remove('hidden');
                setTimeout(() => {
                    resultsModal.classList.add('opacity-100');
                    resultsContent.classList.remove('scale-95', 'opacity-0');
                    resultsContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            function closeModal() {
                resultsModal.classList.remove('opacity-100');
                resultsContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { resultsModal.classList.add('hidden'); }, 300);
            }

            function exportToPDF() {
                try {
                    const doc = new jsPDF();
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(18);
                    doc.text("Parental Rearing Style (EMBU) Results", 105, 15, { align: 'center' });

                    let finalY = 25;

                    const processParent = (parent, color) => {
                        doc.setFontSize(14);
                        doc.text(`${parent.charAt(0).toUpperCase() + parent.slice(1)}'s Rearing Style`, 14, finalY);
                        finalY += 6;
                        doc.autoTable({ 
                            head: [['Dimension', 'Z-Score', 'Result']], 
                            body: Object.values(currentResults[parent]).map(res => [res.name_en, res.zScore, res.interpretation_en]), 
                            startY: finalY, 
                            headStyles: { fillColor: color } 
                        });
                        finalY = doc.lastAutoTable.finalY + 10;

                        for (const factorId in currentResults[parent]) {
                            const res = currentResults[parent][factorId];
                            if (res.contributingItems.length > 0) {
                                if (finalY > 260) { doc.addPage(); finalY = 20; }
                                doc.setFont("helvetica", "bold");
                                doc.setFontSize(10);
                                doc.text(`Key Item Analysis for: ${res.name_en}`, 14, finalY);
                                finalY += 5;
                                doc.setFont("helvetica", "normal");
                                doc.setFontSize(8);
                                const itemsText = res.contributingItems.map(item => `Q${item.id}: ${item.text} (Answer: ${item.answer_en})`).join('\n');
                                const splitText = doc.splitTextToSize(itemsText, 180);
                                doc.text(splitText, 16, finalY);
                                finalY += (splitText.length * 3.5) + 5;
                            }
                        }
                    };

                    processParent('father', [41, 128, 185]);
                    if (finalY > 200) { doc.addPage(); finalY = 20; }
                    finalY += 5;
                    processParent('mother', [192, 57, 43]);

                    doc.save("EMBU-Results.pdf");
                } catch (err) {
                    console.error("PDF Export Error:", err);
                    showError("导出PDF失败 (Failed to export PDF.)");
                }
            }

            function exportToExcel() {
                const data = [["Question No.", "Question", "Father's Answer (1-4)", "Mother's Answer (1-4)"]];
                const answerLabels = ['从不', '偶尔', '经常', '总是'];
                for(let i = 0; i < questions.length; i++) {
                    const fatherAns = currentUserAnswers.father[i];
                    const motherAns = currentUserAnswers.mother[i];
                    data.push([i + 1, questions[i], `${fatherAns} (${answerLabels[fatherAns-1]})`, `${motherAns} (${answerLabels[motherAns-1]})`]);
                }
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Answers");
                XLSX.writeFile(wb, "EMBU-Answers.xlsx");
            }

            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        if (json.length < questions.length) { 
                            throw new Error(`Excel文件内容不完整，应包含 ${questions.length} 行答案。`);
                        }

                        const answers = { father: [], mother: [] };
                        for (let i = 0; i < questions.length; i++) {
                            const row = json[i];
                            const qNum = i + 1;
                            if (!row || row[1] === undefined || row[2] === undefined) throw new Error(`第 ${qNum} 行答案缺失。`);
                            
                            const fatherAns = parseInt(row[1], 10);
                            const motherAns = parseInt(row[2], 10);

                            if (isNaN(fatherAns) || fatherAns < 1 || fatherAns > 4) throw new Error(`第 ${qNum} 行父亲的答案 "${row[1]}" 无效。`);
                            if (isNaN(motherAns) || motherAns < 1 || motherAns > 4) throw new Error(`第 ${qNum} 行母亲的答案 "${row[2]}" 无效。`);
                            
                            answers.father.push(fatherAns);
                            answers.mother.push(motherAns);
                        }
                        performCalculation(answers);
                    } catch (err) {
                        showError(`文件处理失败: ${err.message}`);
                    } finally {
                        fileInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            // Event Listeners
            calculateBtn.addEventListener('click', calculateScoreFromForm);
            closeBtn.addEventListener('click', closeModal);
            exportPdfBtn.addEventListener('click', exportToPDF);
            exportExcelBtn.addEventListener('click', exportToExcel);
            importBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            resultsModal.addEventListener('click', (e) => {
                if (e.target.tagName === 'SUMMARY') {
                    const details = e.target.parentElement;
                    const content = details.querySelector('.details-content');
                    if (details.open) {
                       // It's about to close
                    } else {
                       // It's about to open
                    }
                }
                if (e.target === resultsModal) closeModal();
            });

            generateQuestions();
        });
    </script>
</body>
</html>
