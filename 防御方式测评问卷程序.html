<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defense Style Questionnaire (DSQ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        input[type="radio"]:focus-visible + label {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
            border-radius: 0.25rem;
        }
        .radio-group-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-900 mb-2">防御方式问卷 (DSQ)</h1>
            <p class="text-center text-gray-500 mb-8">Defense Style Questionnaire</p>
            <p class="text-center text-sm text-gray-600 mb-2">指导语：请仔细阅读每一个问题，然后根据自己的实际情况认真选择。每个问题有9个答案，1表示“完全反对”，9表示“完全同意”。</p>

            <!-- Excel Import -->
            <div id="excel-import-section" class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">从Excel导入答案 (Import Answers from Excel)</h2>
                <p class="text-sm text-gray-500 mb-4">文件格式要求：第一列为题号，第二列为答案 (1-9)。</p>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <input type="file" id="excel-file-input" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".xlsx, .xls">
                    <button id="import-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-teal-300 w-full sm:w-auto flex-shrink-0">
                        导入并计算
                    </button>
                </div>
            </div>
            
            <!-- Questions Grid -->
            <div id="questions-container" class="space-y-4 mt-8 pt-6 border-t border-gray-200">
                 <h2 class="text-lg font-semibold mb-3 text-gray-700">在线完成问卷 (Complete Online)</h2>
            </div>

            <!-- Action Button -->
            <div class="mt-10 text-center">
                <button id="calculate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    计算分数 (Calculate Score)
                </button>
            </div>
        </div>

        <!-- Results Modal -->
        <div id="results-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden transition-opacity duration-300">
            <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-5xl w-full transform transition-all duration-300 scale-95 opacity-0 overflow-y-auto max-h-screen" id="results-content">
                <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">测评结果 (Results)</h2>
                
                <div class="w-full max-w-lg mx-auto mb-8">
                    <h3 class="text-xl font-semibold text-center mb-2 text-gray-800">防御风格总览</h3>
                    <canvas id="radar-chart"></canvas>
                </div>

                <div id="detailed-charts-container" class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <div><h4 class="text-lg font-semibold text-center mb-2">不成熟防御机制</h4><canvas id="immature-radar-chart"></canvas></div>
                    <div><h4 class="text-lg font-semibold text-center mb-2">成熟防御机制</h4><canvas id="mature-radar-chart"></canvas></div>
                    <div><h4 class="text-lg font-semibold text-center mb-2">中间型防御机制</h4><canvas id="intermediate-radar-chart"></canvas></div>
                </div>
                
                <div id="interpretation-container" class="mb-6">
                    <!-- Interpretation text will be injected here -->
                </div>

                <div id="results-summary-container" class="mb-6">
                    <!-- Factor summary table will be injected here -->
                </div>
                <div id="results-detail-container">
                    <!-- Detailed mechanism tables will be injected here -->
                </div>
                <div class="mt-8 text-center flex flex-col sm:flex-row justify-center gap-3">
                     <button id="export-excel-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition focus:outline-none focus:ring-4 focus:ring-blue-300">
                        导出Excel
                    </button>
                    <button id="export-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition focus:outline-none focus:ring-4 focus:ring-green-300">
                        导出PDF
                    </button>
                    <button id="close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition focus:outline-none focus:ring-4 focus:ring-gray-300">
                        关闭
                    </button>
                </div>
            </div>
        </div>
        
        <div id="error-box" class="fixed top-5 right-5 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md shadow-lg hidden transition-opacity duration-300" role="alert">
            <p class="font-bold">错误 (Error)</p>
            <p id="error-message">Please answer all questions.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            const questionsContainer = document.getElementById('questions-container');
            const calculateBtn = document.getElementById('calculate-btn');
            const resultsModal = document.getElementById('results-modal');
            const resultsContent = document.getElementById('results-content');
            const resultsSummaryContainer = document.getElementById('results-summary-container');
            const resultsDetailContainer = document.getElementById('results-detail-container');
            const interpretationContainer = document.getElementById('interpretation-container');
            const closeBtn = document.getElementById('close-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const importBtn = document.getElementById('import-btn');
            const fileInput = document.getElementById('excel-file-input');
            const errorBox = document.getElementById('error-box');
            const errorMessageEl = document.getElementById('error-message');
            
            const chartCanvases = {
                main: document.getElementById('radar-chart'),
                immature: document.getElementById('immature-radar-chart'),
                mature: document.getElementById('mature-radar-chart'),
                intermediate: document.getElementById('intermediate-radar-chart')
            };
            let charts = {};

            let currentResults = {};
            let currentUserAnswers = [];

            const questions = [
                "我从帮助他人而获得满足，如果不这样做，我就会变得情绪抑郁", "人们常说我是个脾气暴躁的人", "在我没有时间处理某个棘手的事情时，我可以把它搁置一边", "人们总是不公平地对待我", "我通过做一些积极的或预见性的事情来摆脱自己的焦虑不安，如绘画、做木工活等", "偶尔，我把一些今天该做的事情推迟到明天做", "我不知道为什么总是遇到相同的受挫情境", "我能够相当轻松地嘲笑我自己", "我受到挫折时，表现就象个孩子", "在维护我的利益方面，我羞于与人计较", "我比我认识的人中大多数都强", "人们往往虐待我", "如果某人骗了我或偷了我的钱，我宁愿他得到帮助，而不是受惩罚", "偶尔，我想一些坏得不能说出口的事情", "偶尔，我因一些下流的笑话而大笑", "人们说我象一只驼鸟，把自己的头埋入沙中，换句话说，我往往有意忽视一些不愉快的事情。", "我常常不能竭尽全力地与人竞争", "我常感到比和我在一起的人强", "某人正在想剥夺我所得到的一切", "我有时发怒", "我时常在某种内在力量的驱使下，不由自主地做出些行为", "我宁愿饿死而不愿被迫吃饭", "我常常故意忽视一些危险，似乎我是个超人", "我以有贬低别人威望的能力而自豪", "人们告诉我：我总有被害的感觉", "有时感觉不好时，我就发脾气", "当某些事情使我烦恼时，我常常不由自主地做出些行为", "当遇事不顺心时，我就会生病", "我是一个很有自制力的人", "我简直就像一个不得志的艺术家一样", "我不总是说真话", "当我感到自尊心受伤害时，我就会回避", "我常常不由自主地迫使自己干些过头的事情，以至于其他人不得不限制我", "我的朋友们把我看做乡下佬", "在我愤怒的时候，我常常回避", "我往往对那些确实对我友好的人，比我应该怀疑的人保持更高的警惕性", "我已学得特殊的才能，足以使我毫无问题地渡过一生", "有时，在选举的时候，我往往选那些我几乎不了解的人", "我常常不能按时赴约", "我幻想的多，可在现实生活中做的少", "我羞于与人打交道", "我什么都不怕", "有时我认为我是个天使，有时我认为我是个恶魔", "在比赛时，我只能赢而不能输", "在我愤怒的时候，我变得很愿挖苦人", "在我自尊心受伤害时，我就公开反击", "我认为当我受伤害时，我就应该翻脸", "我每天读报时，不是每个版面都读", "我沮丧时，就会避开", "我对性问题感到害羞", "我总是感到我所认识的某个人象个保护神", "我的处世哲学是：“非理勿信，非理勿做，非理勿视”", "我认为：人有好坏之分", "如果我的上司惹我生气，我可能会在工作中找麻烦或磨洋工，以报复他", "每个人都和我对着干", "我往往对那些我讨厌的人表示友好", "如果我乘坐的飞机的一个发动机失灵；我就会非常紧张", "我认识这样一个人，他什么都能做而且做得合理正直", "如果我感情的发泄会防碍我正从事的事业，那么我就能控制住它", "一些人正在密谋要害我", "我通常可以看到恶境当中好的一面", "在我不得不去做一些我不愿做的事情时，就头痛", "我常常发现我对那些理应仇视的人，表示很友好", "我认为：“人人都有善意”是不存在的，如果你不好，那么你一切都不好", "我决不会对那些我讨厌的人表示愤怒", "我确信生活对我是不公正的", "在严重的打击下，我就会垮下来", "在我意识到不得不面临一场困境的时候，如考试、招工会谈。我就试图想像它会如何，并计划出一些方法去应付它", "医生们决不会真的弄清我患的是什么病", "当某个和我很亲近的人死去时，我并不悲伤", "在我为了利益和人争斗之后，我往往因为我的粗鲁而向人道歉", "发生与我有关的大部分事情并不是我的责任", "当我感觉情绪压抑或焦虑不安时，吃点东西，可以使我感觉好些", "勤奋工作使我感觉好些", "医生不能真的帮我解决问题", "我常听人们说我不暴露自己的感情", "我认为，人们在看电影，戏剧或书籍对所领悟的意义，比这些作品所要表达的意义要多", "我感觉到我有一些不由自主要去做的习惯或仪式行为，并给我带来很多麻烦", "当我紧张时，就喝酒或吃药", "当我心情不愉快时，就想和别人呆在一起", "如果我能够预感到我会沮丧的话，我就能更好地应付它", "无论我怎样发牢骚，从未得到过满意的结果", "我常常发现当环境要引起我强烈的情绪反应时，我就会麻木不仁", "忘我地工作，可使我摆脱情绪上的忧郁和焦虑", "紧张的时候，我就吸烟", "如果我陷入某种危机时，我就地寻找另一个和我具有同样命运的人", "如果我做错了事情，不能受责备", "如果我有攻击他人的想法，我就感觉有种做点事情的需要，以转移这种想法"
            ];
            
            const factors = {
                'immature': {
                    name: '不成熟防御机制', name_en: 'Immature Defenses', color: 'rgba(255, 99, 132, 0.2)', borderColor: 'rgb(255, 99, 132)',
                    mechanisms: {
                        '投射 (Projection)': [4, 12, 25, 36, 55, 60, 66, 72, 87], '被动攻击 (Passive Aggression)': [2, 22, 39, 45, 54],
                        '潜意显现 (Acting Out)': [7, 21, 27, 33, 46], '抱怨 (Complaining)': [69, 75, 82], '幻想 (Fantasy)': [40],
                        '分裂 (Splitting)': [43, 53, 64], '退缩 (Withdrawal)': [9, 67], '躯体化 (Somatization)': [28, 62]
                    }
                },
                'mature': {
                    name: '成熟防御机制', name_en: 'Mature Defenses', color: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgb(75, 192, 192)',
                    mechanisms: {
                        '升华 (Sublimation)': [5, 74, 84], '压抑 (Suppression)': [3, 59], '幽默 (Humor)': [8, 61, 34]
                    }
                },
                'intermediate': {
                    name: '中间型防御机制', name_en: 'Intermediate Defenses', color: 'rgba(255, 205, 86, 0.2)', borderColor: 'rgb(255, 205, 86)',
                    mechanisms: {
                        '反作用形成 (Reaction Formation)': [13, 47, 56, 63, 65], '解除 (Undoing)': [71, 78, 88], '制止 (Inhibition)': [10, 17, 29, 41, 50],
                        '回避 (Avoidance)': [32, 35, 49], '理想化 (Idealization)': [51, 58], '假性利他 (Pseudo-altruism)': [1],
                        '伴无能之全能 (Omnipotence)': [11, 18, 23, 24, 30, 37], '隔离 (Isolation)': [70, 76, 77, 83], '同一化 (Identification)': [19],
                        '否认 (Denial)': [16, 42, 52], '交往倾向 (Affiliation)': [80, 86], '消耗倾向 (Consumption)': [73, 79, 85], '期望 (Anticipation)': [68, 81]
                    }
                },
                'masking': {
                    name: '掩饰因子', name_en: 'Masking Factor', color: 'rgba(153, 102, 255, 0.2)', borderColor: 'rgb(153, 102, 255)',
                    mechanisms: {
                        '掩饰 (Masking)': [6, 14, 15, 20, 26, 31, 38, 44, 48, 57]
                    }
                }
            };
            
            const mechanismIntros = {
                '投射 (Projection)': '将自己不接纳的冲动、想法或情感归咎于他人。', '被动攻击 (Passive Aggression)': '通过消极、间接的方式表达敌意或不满。',
                '潜意显现 (Acting Out)': '通过行动而非反思来表达无意识的冲突。', '抱怨 (Complaining)': '持续抱怨困境或他人，但不采取实际行动解决问题。',
                '幻想 (Fantasy)': '通过想象（如白日梦）逃避现实压力。', '分裂 (Splitting)': '将人或事看作是全好或全坏的，缺乏整合。',
                '退缩 (Withdrawal)': '从现实冲突或压力情境中退出，避免接触。', '躯体化 (Somatization)': '将心理压力转化为躯体症状。',
                '升华 (Sublimation)': '将本能冲动转化为社会认可的、建设性的行为。', '压抑 (Suppression)': '有意识地暂时搁置负面情绪或冲动。',
                '幽默 (Humor)': '以幽默、轻松的态度看待压力事件。', '反作用形成 (Reaction Formation)': '表现与内心真实感受相反的态度或行为。',
                '解除 (Undoing)': '通过特定行为抵消或“弥补”先前的错误或冲动。', '制止 (Inhibition)': '有意识地抑制某些想法、情感或行为。',
                '回避 (Avoidance)': '通过避开引发焦虑的场景、人或话题来减少冲突。', '理想化 (Idealization)': '过度夸大他人或事物的优点，忽视其缺陷。',
                '假性利他 (Pseudo-altruism)': '通过帮助他人满足自身心理需求。', '伴无能之全能 (Omnipotence)': '交替体验“无所不能”和“极度无能”的感觉。',
                '隔离 (Isolation)': '将情感与事件分离，用理智化方式处理。', '同一化 (Identification)': '通过模仿或认同他人来增强自我价值感。',
                '否认 (Denial)': '拒绝承认现实中令人痛苦的部分。', '交往倾向 (Affiliation)': '通过社交活动转移注意力，避免面对内心冲突。',
                '消耗倾向 (Consumption)': '通过过度消耗身体或资源缓解心理压力。', '期望 (Anticipation)': '对未来持积极期待，以此应对当前困境。'
            };
            const mechanismIntros_en = {
                'Projection': 'Attributing one\'s own unacceptable impulses, thoughts, or feelings to others.', 'Passive Aggression': 'Expressing hostility or dissatisfaction in a passive, indirect way.',
                'Acting Out': 'Expressing unconscious conflicts through actions rather than reflection.', 'Complaining': 'Persistently complaining about difficulties or others without taking action.',
                'Fantasy': 'Escaping from reality through imagination, such as daydreaming.', 'Splitting': 'Viewing people or things as either all good or all bad, lacking integration.',
                'Withdrawal': 'Retreating from real conflicts or stressful situations to avoid contact.', 'Somatization': 'Converting psychological stress into physical symptoms.',
                'Sublimation': 'Channeling instinctual impulses into socially acceptable, constructive activities.', 'Suppression': 'Consciously and temporarily setting aside negative emotions or impulses.',
                'Humor': 'Viewing stressful events with a humorous, lighthearted attitude.', 'Reaction Formation': 'Behaving in a manner opposite to one\'s true feelings.',
                'Undoing': 'Trying to "undo" a previous wrong or impulse through a specific action.', 'Inhibition': 'Consciously restraining certain thoughts, feelings, or behaviors.',
                'Avoidance': 'Reducing conflict by avoiding anxiety-provoking scenes, people, or topics.', 'Idealization': 'Exaggerating the positive qualities of others or things while ignoring their flaws.',
                'Pseudo-altruism': 'Helping others to satisfy one\'s own psychological needs.', 'Omnipotence': 'Alternating between feelings of being all-powerful and extremely incompetent.',
                'Isolation': 'Separating emotions from events and dealing with them intellectually.', 'Identification': 'Enhancing self-worth by imitating or identifying with others.',
                'Denial': 'Refusing to acknowledge painful aspects of reality.', 'Affiliation': 'Diverting attention from internal conflicts through social activities.',
                'Consumption': 'Relieving psychological stress by excessively consuming physical or material resources.', 'Anticipation': 'Coping with current difficulties by holding positive expectations for the future.'
            };


            function generateQuestions() {
                let questionsHTML = '';
                const options = ['1', '2', '3', '4', '5', '6', '7', '8', '9'];
                questions.forEach((text, index) => {
                    const i = index + 1;
                    let optionsHTML = '<div class="radio-group-grid w-full">';
                    options.forEach((opt, val) => {
                        const score = val + 1;
                        optionsHTML += `<div class="flex items-center justify-center"><input type="radio" id="q${i}-${score}" name="q${i}" value="${score}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><label for="q${i}-${score}" class="ml-2 text-sm text-gray-600">${opt}</label></div>`;
                    });
                    optionsHTML += '</div>';
                    questionsHTML += `
                        <div class="flex flex-col items-start justify-between bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <span class="font-medium text-gray-700 mb-3">${i}. ${text}</span>
                            ${optionsHTML}
                        </div>`;
                });
                questionsContainer.innerHTML += questionsHTML;
            }

            function showError(message) {
                errorMessageEl.textContent = message;
                errorBox.classList.remove('hidden');
                setTimeout(() => { errorBox.classList.add('hidden'); }, 3000);
            }

            function getAnswersFromForm() {
                const answers = [];
                for (let i = 1; i <= questions.length; i++) {
                    const answerEl = document.querySelector(`input[name="q${i}"]:checked`);
                    if (answerEl) {
                        answers.push(parseInt(answerEl.value, 10));
                    } else {
                        answers.push(null);
                    }
                }
                return answers;
            }

            function performCalculation(answers) {
                if (answers.some(a => a === null)) {
                    showError(`请回答所有 ${questions.length} 个问题。`);
                    return;
                }
                
                currentUserAnswers = answers;
                let results = {};
                let allMechanisms = [];

                for (const factorId in factors) {
                    const factor = factors[factorId];
                    let factorTotalScore = 0;
                    let factorTotalItems = 0;
                    let mechanismResults = {};

                    for (const mechName in factor.mechanisms) {
                        const itemIndices = factor.mechanisms[mechName];
                        let mechScore = 0;
                        itemIndices.forEach(index => {
                            mechScore += answers[index - 1];
                        });
                        const mechMean = mechScore / itemIndices.length;
                        mechanismResults[mechName] = { score: mechScore, mean: mechMean.toFixed(2), items: itemIndices.length };
                        factorTotalScore += mechScore;
                        factorTotalItems += itemIndices.length;
                        if(factorId !== 'masking'){
                           allMechanisms.push({name: mechName, mean: mechMean, factorId: factorId});
                        }
                    }
                    const factorMean = factorTotalScore / factorTotalItems;
                    results[factorId] = {
                        name: factor.name,
                        name_en: factor.name_en,
                        color: factor.color,
                        borderColor: factor.borderColor,
                        mean: factorMean.toFixed(2),
                        mechanisms: mechanismResults
                    };
                }

                allMechanisms.sort((a, b) => b.mean - a.mean);
                results.topThree = allMechanisms.slice(0, 3);
                results.bottomThree = allMechanisms.slice(-3).reverse();

                displayResults(results);
            }

            function calculateScoreFromForm() {
                const answers = getAnswersFromForm();
                performCalculation(answers);
            }
            
            function createOrUpdateChart(canvas, labels, data, label, color, borderColor) {
                if (charts[canvas.id]) {
                    charts[canvas.id].destroy();
                }
                charts[canvas.id] = new Chart(canvas, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label, data: data, fill: true,
                            backgroundColor: color, borderColor: borderColor,
                            pointBackgroundColor: borderColor, pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff', pointHoverBorderColor: borderColor
                        }]
                    },
                    options: {
                        elements: { line: { borderWidth: 3 } },
                        scales: { r: { beginAtZero: true, max: 9, min: 1, ticks: { stepSize: 2 } } },
                        plugins: { legend: { display: canvas.id === 'radar-chart' }, tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${context.raw}` } } }
                    }
                });
            }

            function displayResults(results) {
                currentResults = results;
                
                const mainChartLabels = [results.mature.name, results.intermediate.name, results.immature.name];
                const mainChartData = [results.mature.mean, results.intermediate.mean, results.immature.mean];
                createOrUpdateChart(chartCanvases.main, mainChartLabels, mainChartData, '防御风格平均分', 'rgba(54, 162, 235, 0.2)', 'rgb(54, 162, 235)');
                
                for (const factorId in results) {
                    if (chartCanvases[factorId]) {
                        const factor = results[factorId];
                        const labels = Object.keys(factor.mechanisms);
                        const data = Object.values(factor.mechanisms).map(m => m.mean);
                        createOrUpdateChart(chartCanvases[factorId], labels, data, factor.name, factor.color, factor.borderColor);
                    }
                }

                const factorScores = {
                    mature: parseFloat(results.mature.mean),
                    intermediate: parseFloat(results.intermediate.mean),
                    immature: parseFloat(results.immature.mean)
                };
                const dominantStyle = Object.keys(factorScores).reduce((a, b) => factorScores[a] > factorScores[b] ? a : b);

                const topThreeCounts = { mature: 0, intermediate: 0, immature: 0 };
                results.topThree.forEach(m => {
                    topThreeCounts[m.factorId]++;
                });
                
                let interpretationHTML = `<div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-xl font-semibold text-center mb-4 text-gray-800">防御机制解读</h3>`;
                interpretationHTML += `<p class="text-center mb-4 text-sm">您使用最多的防御风格是：<strong>${results[dominantStyle].name}</strong>。</p>`;
                interpretationHTML += `<div class="mb-4"><h4 class="font-semibold text-green-700">您最常用的三种防御机制是：</h4><ul class="list-disc list-inside ml-4 text-sm space-y-1">`;
                results.topThree.forEach(m => {
                    interpretationHTML += `<li><strong>${m.name} (均分: ${m.mean.toFixed(2)})</strong>: ${mechanismIntros[m.name]}</li>`;
                });
                interpretationHTML += `</ul></div><div class="mb-4"><h4 class="font-semibold text-blue-700">您最少使用的三种防御机制是：</h4><ul class="list-disc list-inside ml-4 text-sm space-y-1">`;
                results.bottomThree.forEach(m => {
                    interpretationHTML += `<li><strong>${m.name} (均分: ${m.mean.toFixed(2)})</strong>: ${mechanismIntros[m.name]}</li>`;
                });
                interpretationHTML += `</ul></div>`;
                interpretationHTML += `<div class="border-t pt-4 mt-4"><p class="text-sm">在您最常用的三种防御机制中，有 <strong>${topThreeCounts.mature}</strong> 种成熟防御，<strong>${topThreeCounts.intermediate}</strong> 种中间型防御，以及 <strong>${topThreeCounts.immature}</strong> 种不成熟防御。</p>`;
                if (topThreeCounts.immature >= 2) {
                    interpretationHTML += `<p class="text-sm font-semibold text-red-600 mt-2">提示：您倾向于较多使用不成熟的防御机制来应对压力，这可能在短期内有效，但长期来看可能会阻碍个人成长。建议关注并尝试培养更多成熟的应对策略。</p>`;
                }
                interpretationHTML += `</div></div>`;
                interpretationContainer.innerHTML = interpretationHTML;


                let summaryHTML = `<h3 class="text-xl font-semibold text-center mb-4 text-gray-800">防御风格总览</h3>
                    <table class="min-w-full divide-y divide-gray-200 mb-8">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">防御风格</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">平均分</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;
                for (const factorId in results) {
                     if(factorId === 'topThree' || factorId === 'bottomThree') continue;
                    summaryHTML += `<tr>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${results[factorId].name}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">${results[factorId].mean}</td>
                    </tr>`;
                }
                summaryHTML += `</tbody></table>`;
                resultsSummaryContainer.innerHTML = summaryHTML;

                let detailHTML = `<h3 class="text-xl font-semibold text-center mb-4 text-gray-800">各项防御机制得分</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;
                for (const factorId in results) {
                    if(factorId === 'topThree' || factorId === 'bottomThree') continue;
                    detailHTML += `<div><h4 class="text-lg font-semibold text-gray-700 mb-2">${results[factorId].name}</h4>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">机制</th><th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">均分</th></tr></thead>
                            <tbody class="bg-white divide-y divide-gray-200">`;
                    for (const mechName in results[factorId].mechanisms) {
                        detailHTML += `<tr>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-800">${mechName}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${results[factorId].mechanisms[mechName].mean}</td>
                        </tr>`;
                    }
                    detailHTML += `</tbody></table></div>`;
                }
                detailHTML += `</div>`;
                resultsDetailContainer.innerHTML = detailHTML;
                
                resultsModal.classList.remove('hidden');
                setTimeout(() => {
                    resultsModal.classList.add('opacity-100');
                    resultsContent.classList.remove('scale-95', 'opacity-0');
                    resultsContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            function closeModal() {
                resultsModal.classList.remove('opacity-100');
                resultsContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { resultsModal.classList.add('hidden'); }, 300);
            }

            function getEnglishMechanismName(fullName) {
                const match = fullName.match(/\(([^)]+)\)/);
                return match ? match[1] : fullName;
            }

            async function exportToPDF() {
                try {
                    const doc = new jsPDF();
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(18);
                    doc.text("Defense Style Questionnaire (DSQ) Results", 105, 15, { align: 'center' });

                    let finalY = 25;
                    
                    doc.addImage(chartCanvases.main.toDataURL('image/png'), 'PNG', 40, finalY, 130, 100);
                    finalY += 110;

                    const chartsToExport = ['immature', 'mature', 'intermediate'];
                    for (const id of chartsToExport) {
                        if (finalY > 190) { doc.addPage(); finalY = 20; }
                        doc.setFontSize(14);
                        doc.text(currentResults[id].name_en, 105, finalY, { align: 'center' });
                        finalY += 5;
                        doc.addImage(chartCanvases[id].toDataURL('image/png'), 'PNG', 55, finalY, 100, 80);
                        finalY += 90;
                    }
                    
                    doc.addPage();
                    finalY = 20;

                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(14);
                    doc.text("Defense Mechanism Interpretation", 14, finalY);
                    finalY += 8;
                    
                    const factorScores = {
                        mature: parseFloat(currentResults.mature.mean),
                        intermediate: parseFloat(currentResults.intermediate.mean),
                        immature: parseFloat(currentResults.immature.mean)
                    };
                    const dominantStyleId = Object.keys(factorScores).reduce((a, b) => factorScores[a] > factorScores[b] ? a : b);
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    doc.text(`Your most used defense style is: ${currentResults[dominantStyleId].name_en}.`, 14, finalY);
                    finalY += 8;

                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(11);
                    doc.text("Your Top 3 Most Used Defenses:", 14, finalY);
                    finalY += 6;
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9);
                    let topThreeText = currentResults.topThree.map(m => {
                        const en_name = getEnglishMechanismName(m.name);
                        return `${en_name} (Mean: ${m.mean.toFixed(2)}):\n${mechanismIntros_en[en_name]}`;
                    }).join('\n\n');
                    let splitText = doc.splitTextToSize(topThreeText, 180);
                    doc.text(splitText, 16, finalY);
                    finalY += (splitText.length * 3.5) + 8;

                    if (finalY > 250) { doc.addPage(); finalY = 20; }
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(11);
                    doc.text("Your 3 Least Used Defenses:", 14, finalY);
                    finalY += 6;
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9);
                    let bottomThreeText = currentResults.bottomThree.map(m => {
                        const en_name = getEnglishMechanismName(m.name);
                        return `${en_name} (Mean: ${m.mean.toFixed(2)}):\n${mechanismIntros_en[en_name]}`;
                    }).join('\n\n');
                    splitText = doc.splitTextToSize(bottomThreeText, 180);
                    doc.text(splitText, 16, finalY);
                    finalY += (splitText.length * 3.5) + 8;

                    const topThreeCounts = { mature: 0, intermediate: 0, immature: 0 };
                    currentResults.topThree.forEach(m => { topThreeCounts[m.factorId]++; });
                    let summaryText = `Among your top 3 defenses, there are ${topThreeCounts.mature} mature, ${topThreeCounts.intermediate} intermediate, and ${topThreeCounts.immature} immature defenses.`;
                    if (topThreeCounts.immature >= 2) {
                        summaryText += `\nNote: You tend to rely more on immature defense mechanisms. While sometimes effective in the short term, they may hinder long-term personal growth. It's advisable to focus on developing more mature coping strategies.`;
                    }
                    if (finalY > 250) { doc.addPage(); finalY = 20; }
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(10);
                    splitText = doc.splitTextToSize(summaryText, 180);
                    doc.text(splitText, 14, finalY);
                    finalY += (splitText.length * 5) + 10;


                    if (finalY > 250) { doc.addPage(); finalY = 20; }
                    doc.setFontSize(14);
                    doc.text("Defense Style Summary", 14, finalY);
                    finalY += 6;
                    doc.autoTable({
                        head: [['Style', 'Average Score']],
                        body: Object.values(currentResults).filter(r => r.name_en).map(res => [res.name_en, res.mean]),
                        startY: finalY,
                        headStyles: { fillColor: [74, 85, 104] }
                    });
                    finalY = doc.lastAutoTable.finalY + 15;

                    doc.addPage();
                    finalY = 20;
                    doc.setFontSize(14);
                    doc.text("Detailed Mechanism Scores", 14, finalY);
                    finalY += 6;

                    for (const factorId in currentResults) {
                         if(factorId === 'topThree' || factorId === 'bottomThree') continue;
                        const factor = currentResults[factorId];
                        if (finalY > 250) { doc.addPage(); finalY = 20; }
                        doc.setFont("helvetica", "bold");
                        doc.setFontSize(12);
                        doc.text(factor.name_en, 14, finalY);
                        finalY += 6;
                        const bodyData = Object.entries(factor.mechanisms).map(([name, data]) => {
                            return [getEnglishMechanismName(name), data.mean];
                        });
                        doc.autoTable({
                            head: [['Mechanism', 'Average Score']],
                            body: bodyData,
                            startY: finalY,
                            theme: 'grid',
                            headStyles: { fillColor: [241, 243, 244] , textColor: [0,0,0]},
                            styles: { fontSize: 9 }
                        });
                        finalY = doc.lastAutoTable.finalY + 10;
                    }

                    doc.save("DSQ-Results.pdf");
                } catch (err) {
                    console.error("PDF Export Error:", err);
                    showError("导出PDF失败 (Failed to export PDF.)");
                }
            }

            function exportToExcel() {
                const data = [["Question No.", "Question", "Answer (1-9)"]];
                for(let i = 0; i < questions.length; i++) {
                    data.push([i + 1, questions[i], currentUserAnswers[i]]);
                }
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Answers");
                XLSX.writeFile(wb, "DSQ-Answers.xlsx");
            }

            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        if (json.length < questions.length) { 
                            throw new Error(`Excel文件内容不完整，应包含 ${questions.length} 行答案。`);
                        }

                        const answers = [];
                        for (let i = 0; i < questions.length; i++) {
                            const row = json[i];
                            const qNum = i + 1;
                            if (!row || row[1] === undefined) throw new Error(`第 ${qNum} 行答案缺失。`);
                            const answer = parseInt(row[1], 10);
                            if (isNaN(answer) || answer < 1 || answer > 9) throw new Error(`第 ${qNum} 行的答案 "${row[1]}" 无效。`);
                            answers.push(answer);
                        }
                        performCalculation(answers);
                    } catch (err) {
                        showError(`文件处理失败: ${err.message}`);
                    } finally {
                        fileInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            calculateBtn.addEventListener('click', calculateScoreFromForm);
            closeBtn.addEventListener('click', closeModal);
            exportPdfBtn.addEventListener('click', exportToPDF);
            exportExcelBtn.addEventListener('click', exportToExcel);
            importBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            resultsModal.addEventListener('click', (e) => {
                if (e.target === resultsModal) closeModal();
            });

            generateQuestions();
        });
    </script>
</body>
</html>
